<!DOCTYPE html>
<html>
<head>
    <title>Map</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="referer" content="origin"/>
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <style type="text/css">
        #map {
            height: 100%;
            background-color: white;
            background-position: center center;
            background-repeat: no-repeat;
        }

        html {
            height: 100%;
        }

        body {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        .leaflet-top, .leaflet-bottom {
            position: fixed;
        }

        .display-bbox {
            background: hsla(0, 0%, 99%, 0.8);
        }

    </style>
    <script type="text/javascript" src="//unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script type="text/javascript" src="//unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>

    <script type="text/javascript" src="//unpkg.com/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.js"></script>
    <link rel="stylesheet" href="//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//unpkg.com/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.css"/>


</head>
<body>
<div id="map"></div>
<script type="text/javascript">
    window.onload = function () {
        var map = L.map("map", {
            zoomControl: false
        }).setView([48.845, 2.424], 10)

        function toHistory() {
            let data = {
                lat: +map.getCenter().lat.toFixed(6),
                lng: +map.getCenter().lng.toFixed(6),
                zoom: map.getZoom(),
            };
            return [data, undefined, '#' + Object.entries(data).map(e => {
                return e.join('=')
            }).join('&')]
        }

        history.replaceState.apply(history, toHistory())

        map.on('moveend', function () {
            history.pushState.apply(history, toHistory())
        })

        window.addEventListener('popstate', function (e) {
            if (e.state) {
                map.setView(L.latLng(e.state.lat, e.state.lng), e.state.zoom)
            } else {
                const o = location.hash.slice(1).split('&')
                    .map(x => x.split('='))
                    .reduce((a, b) => {
                        a[b[0]] = b[1]
                        return a
                    }, {})
                map.setView(L.latLng(o.lat, o.lng), o.zoom)
            }
        })

        let baseLayers = {
            fr: L.tileLayer.provider("OpenStreetMap.France"),
            ign: L.tileLayer.provider("GeoportailFrance.ignMaps", {
                apikey: 's0rdzriarwz8byka6xjtdb9r',
            }),
            osm: L.tileLayer.provider("OpenStreetMap.Mapnik"),
            topo: L.tileLayer.provider("OpenTopoMap"),
        }
        L.control.layers(baseLayers, {
            relief: L.tileLayer.provider("HikeBike.HillShading")
        }).addTo(map);

        map.addLayer(Object.values(baseLayers)[0])

        let displayBbox = new (L.Control.extend({
            onAdd: function (m) {
                this._map = m
                this._container = document.createElement('div')
                this._w = document.createElement('span')
                this._label0 = document.createElement('div')
                this._label0.innerText = 'BBox ðŸ“‹'
                this._container.setAttribute('class', 'display-bbox')
                this._w.addEventListener('click', this._copy.bind(this))
                this._map.on('moveend', this._displayBbox.bind(this))
                this._displayBbox()
                this._displayBbox()
                this._displayBbox()
                this._container.appendChild(this._label0)
                this._container.appendChild(this._w)
                return this._container
            },
            _copy: function () {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(this._w);
                selection.removeAllRanges();
                selection.addRange(range);
                try {
                    document.execCommand('copy');
                    selection.removeAllRanges();
                } catch (e) {

                }
            },
            _displayBbox: function () {
                let bounds = this._map.getBounds();
                this._w.innerHTML = `N: ${+bounds.getNorth().toFixed(6)}`
                    + `<br/>S: : ${+bounds.getSouth().toFixed(6)}`
                    + `<br/>E: : ${+bounds.getEast().toFixed(6)}`
                    + `<br/>W: : ${+bounds.getWest().toFixed(6)}`
            },

            onRemove: function() {
                this._w.parentNode.removeChild(this._w)
                this._map = undefined
            },
            getPosition: () => 'topleft'
        }))()
        displayBbox.addTo(map)

        L.control.locate().addTo(map)

        L.control.scale({
            imperial: false,
            maxWidth: Math.round(window.screen.width / 3)
        }).addTo(map)

        function viewportZoom(offset) {
            return () => {
                var vp = document.querySelector("meta[name=viewport]");
                let content = vp.getAttribute("content")
                var initialScale = (/initial-scale=(.+)/).exec(content);
                vp.setAttribute("content", content.replace(initialScale[0], "initial-scale=" + (parseFloat(initialScale[1]) + offset)))
                setTimeout(() => map.invalidateSize(false), 0)
            }
        }

        (new (L.Control.Zoom.extend({
            _zoomIn: viewportZoom(0.1),
            _zoomOut: viewportZoom(-0.1)
        }))()).addTo(map)
    }
</script>
</body>
</html>
